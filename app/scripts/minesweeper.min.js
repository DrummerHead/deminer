function Minesweeper(v,o){var y=this;var i;var w;var b;var m;var H;var E;var A;var C;var d;var N=new z();var F;var g;var a;var O;var G;var p;var k;var x;var e;var s;J();this.newGame=function(){var W,U;var T,V;var S;T=L();S=o();i=S.gameTypeId;w=S.numRows;b=S.numCols;m=S.numMines;H=S.zoom;V=(L()!=T);t(H);if(V){P()}l();if(!V){for(W=1;W<=w;W++){for(U=1;U<=b;U++){C[W][U].setClass("square blank")}}}N.stop();N.reset();E=m;A=w*b-m;Q();F=false;g=false;a=0;O=0;x=false;e=false;s=false;$("#face")[0].className="facesmile";hoveredSquareId=""};this.resize=function(S){var T=n(S);t(S);$("#game-container").removeClass("z"+H*100).addClass("z"+S*100);$("#face").css({"margin-left":Math.floor(T)+"px","margin-right":Math.ceil(T)+"px"});H=S};function t(S){$("#game-container, #game").width(S*(b*16+20));$("#game").height(S*(w*16+30+26+6))}function n(S){return(S*b*16-6*Math.ceil(S*13)-S*2*6-S*26)/2}function L(){return w+"_"+b+"_"+m}function P(){var V,S;var T=[];var U=n(H);T.push('<div class="bordertl"></div>');for(S=0;S<b;S++){T.push('<div class="bordertb"></div>')}T.push('<div class="bordertr"></div>');T.push('<div class="borderlrlong"></div>','<div class="time0" id="mines_hundreds"></div>','<div class="time0" id="mines_tens"></div>','<div class="time0" id="mines_ones"></div>','<div class="facesmile" style="margin-left:',Math.floor(U),"px; margin-right: ",Math.ceil(U),'px;" id="face"></div>','<div class="time0" id="seconds_hundreds"></div>','<div class="time0" id="seconds_tens"></div>','<div class="time0" id="seconds_ones"></div>','<div class="borderlrlong"></div>');T.push('<div class="borderjointl"></div>');for(S=0;S<b;S++){T.push('<div class="bordertb"></div>')}T.push('<div class="borderjointr"></div>');for(V=1;V<=w;V++){T.push('<div class="borderlr"></div>');for(S=1;S<=b;S++){T.push('<div class="square blank" id="',V,",",S,'"></div>')}T.push('<div class="borderlr"></div>')}T.push('<div class="borderbl"></div>');for(S=0;S<b;S++){T.push('<div class="bordertb"></div>')}T.push('<div class="borderbr"></div>');for(S=0;S<=b+1;S++){T.push('<div class="square blank" style="display: none;" id="',0,",",S,'"></div>')}for(S=0;S<=b+1;S++){T.push('<div class="square blank" style="display: none;" id="',w+1,",",S,'"></div>')}for(V=1;V<=w;V++){T.push('<div class="square blank" style="display: none;" id="',V,",",0,'"></div>');T.push('<div class="square blank" style="display: none;" id="',V,",",b+1,'"></div>')}$("#game").html(T.join(""))}function r(X,T){var V=0;var U=false;var S=false;var W=false;this.addToValue=function(Y){V+=Y};this.isMine=function(){return V<0};this.isFlagged=function(){return U};this.isMarked=function(){return S};this.isRevealed=function(){return W};this.isHidden=function(){return X<1||X>w||T<1||T>b};this.getRow=function(){return X};this.getCol=function(){return T};this.getValue=function(){return V};this.setRevealed=function(Y){W=Y};this.plantMine=function(){V-=10;C[X-1][T-1].addToValue(1);C[X-1][T].addToValue(1);C[X-1][T+1].addToValue(1);C[X][T-1].addToValue(1);C[X][T+1].addToValue(1);C[X+1][T-1].addToValue(1);C[X+1][T].addToValue(1);C[X+1][T+1].addToValue(1)};this.unplantMine=function(){V+=10;C[X-1][T-1].addToValue(-1);C[X-1][T].addToValue(-1);C[X-1][T+1].addToValue(-1);C[X][T-1].addToValue(-1);C[X][T+1].addToValue(-1);C[X+1][T-1].addToValue(-1);C[X+1][T].addToValue(-1);C[X+1][T+1].addToValue(-1)};this.setClass=function(Y){document.getElementById(X+","+T).className=Y};this.reveal1=function(){var Y,Z;var aa,ab;var ac=[];ac.push(this);this.pushed=true;while(ac.length>0){aa=ac.pop();if(!aa.isRevealed()&&!aa.isFlagged()){if(aa.isMine()){return false}else{if(!aa.isFlagged()){aa.setClass("square open"+aa.getValue());aa.setRevealed(true);if(aa.getValue()==0){a++}else{O++}if(!aa.isHidden()&&--A==0){D();return true}if(aa.getValue()==0&&!aa.isHidden()){for(Y=-1;Y<=1;Y++){for(Z=-1;Z<=1;Z++){ab=C[aa.getRow()+Y][aa.getCol()+Z];if(!ab.pushed&&!ab.isHidden()&&!ab.isRevealed()){ac.push(ab);ab.pushed=true}}}}}}}}return true};this.reveal9=function(){if(W){var Z,aa;var ab;var ac=0;var Y=[];for(Z=-1;Z<=1;Z++){for(aa=-1;aa<=1;aa++){ab=C[X+Z][T+aa];if(ab!=this&&ab.isFlagged()){ac++}}}if(ac==V){for(Z=-1;Z<=1;Z++){for(aa=-1;aa<=1;aa++){ab=C[X+Z][T+aa];if(ab!=this&&!ab.reveal1()){Y.push(ab)}}}if(Y.length>0){K(Y)}}}};this.flag=function(){if(!W){if(U){if($("#marks").attr("checked")){this.setClass("square question");S=true}else{this.setClass("square blank")}U=false;E++;Q()}else{if(S){this.setClass("square blank");S=false}else{this.setClass("square bombflagged");U=true;E--;Q()}}}}}function l(){var V,S,T;var U;C=[];d=[];G=[];T=0;for(V=0;V<=w+1;V++){C[V]=[];for(S=0;S<=b+1;S++){U=new r(V,S);C[V][S]=U;d[V+","+S]=U;if(!U.isHidden()){G[T++]=U}}}for(T=0;T<m;T++){G.splice(Math.floor(Math.random()*G.length),1)[0].plantMine()}}function q(aa){var S=aa.getRow();var Y=aa.getCol();var X,T;var W;var Z;var U;if(aa.isMine()){G.splice(Math.floor(Math.random()*G.length),1)[0].plantMine();aa.unplantMine();G.push(aa)}var Z=[];for(var V=0;V<G.length;V++){U=G[V];if(U.getRow()<S-1||U.getRow()>S+1||U.getCol()<Y-1||U.getCol()>Y+1){Z.push(U)}}for(X=-1;X<=1;X++){for(T=-1;T<=1;T++){W=C[S+X][Y+T];if(W.isMine()&&Z.length>0){Z.splice(Math.floor(Math.random()*Z.length),1)[0].plantMine();W.unplantMine()}}}N.start();if((S==1&&Y==1)||(S==1&&Y==b)||(S==w&&Y==1)||(S==w&&Y==b)){return 1}else{if(S==1||S==w||Y==1||Y==b){return 2}else{return 3}}}function R(S){if(i>0){j();$.post("start.php",{key:p,s:S,zc:a,nzc:O})}}function j(){var S="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var T;p="";for(var T=0;T<3;T++){p+=S.charAt(Math.floor(Math.random()*S.length))}p+=4*(Math.floor(Math.random()*225)+25)+i;for(var T=0;T<4;T++){p+=S.charAt(Math.floor(Math.random()*S.length))}}function z(){var U;var V;var W;function T(){var aa=new Date().getTime();var X=V*1000;var Z=aa-U;var Y=1000-(Z-X);W=setTimeout(T,Y);V++;S()}function S(){var X=u(V);document.getElementById("seconds_hundreds").className="time"+X[0];document.getElementById("seconds_tens").className="time"+X[1];document.getElementById("seconds_ones").className="time"+X[2]}this.start=function(){V=0;U=new Date().getTime();T()};this.stop=function(){clearTimeout(W)};this.reset=function(){V=0;S()};this.getTime=function(){return V}}function Q(){var S=u(E);document.getElementById("mines_hundreds").className="time"+S[0];document.getElementById("mines_tens").className="time"+S[1];document.getElementById("mines_ones").className="time"+S[2]}function u(S){S=Math.min(S,999);if(S>=0){return[Math.floor(S/100),Math.floor((S%100)/10),S%10]}else{return["-",Math.floor((-S%100)/10),-S%10]}}function K(S){var W,T,U;var V;document.getElementById("face").className="facedead";N.stop();F=true;for(W=1;W<=w;W++){columnloop:for(T=1;T<=b;T++){V=C[W][T];if(!V.isRevealed()){for(U=0;U<S.length;U++){if(V==S[U]){V.setClass("square bombdeath");continue columnloop}}if(V.isMine()&&!V.isFlagged()){V.setClass("square bombrevealed")}else{if(!V.isMine()&&V.isFlagged()){V.setClass("square bombmisflagged")}}}}}}function D(){var X,S;var U;var T;var V;var W=false;document.getElementById("face").className="facewin";N.stop();F=true;E=0;Q();for(X=1;X<=w;X++){for(S=1;S<=b;S++){U=C[X][S];if(!U.isRevealed()&&!U.isFlagged()){U.setClass("square bombflagged")}}}if(i>0){V=N.getTime();for(T=3;T>=0;T--){if(V<=v[T][i-1]){B(T+1,true);W=true;break}}if(!W&&((i==1&&V<=10)||(i==2&&V<=50)||(i==3&&V<=150))){B(1,false)}if(y.onWin){y.onWin(i,V)}}}function B(V,Y){var S;var T,W;var U=(new Date()).getTime();var X;switch(V){case 1:S="daily";break;case 2:S="weekly";break;case 3:S="monthly";break;case 4:S="all-time";break;default:S="";break}W=(I()&&!!localStorage.name)?localStorage.name:"";if(Y){T=prompt("New "+S+" high score! Please enter your name",W)}else{T=prompt("Please enter your name to submit your score",W)}T=$.trim(T);if(T.length>25){T.substring(0,25)}if(I()){localStorage.name=T}X=Math.round(((new Date()).getTime()-U)/1000);$.post("win.php",{key:p,name:T,time:N.getTime(),s:X,i:V,h:Y?1:0},function(Z){if(Y&&y.onNewHighScore){y.onNewHighScore(V)}})}function I(){try{return"localStorage" in window&&window.localStorage!==null}catch(S){return false}}function M(S){return S.className.substring(0,6)=="square"}function f(T){var S={};if(k){S.left=T.button==1||T.button==3||T.button==4;S.right=T.button==2||T.button==3||T.button==4}else{S.left=T.button==0||T.button==1;S.right=T.button==2||T.button==1}return S}function h(U,T,S){if(!U.isRevealed()){if(U.isMarked()){U.setClass(S)}else{if(!U.isFlagged()){U.setClass(T)}}}}function c(W,V,U){var S,T;for(S=-1;S<=1;S++){for(T=-1;T<=1;T++){h(C[W.getRow()+S][W.getCol()+T],V,U)}}}function J(){var U=false;var V;function T(W){if(W.target!=V&&!x){if(s){if(V){c(d[V.id],"square blank","square question")}if(M(W.target)){c(d[W.target.id],"square open0","square questionpressed")}}else{if(V){h(d[V.id],"square blank","square question")}if(M(W.target)){h(d[W.target.id],"square open0","square questionpressed")}}}V=(M(W.target))?W.target:undefined}function S(W){document.getElementById("face").className=(W.target.id=="face")?"facepressed":"facesmile"}k=$.browser.msie&&parseFloat($.browser.version)<=7;$(document).mousedown(function(X){var W=f(X);e=W.left||e;s=W.right||s;if(e){if(M(X.target)&&!F){X.preventDefault();$(document).bind("mousemove",T);document.getElementById("face").className="faceooh";V=undefined;T(X)}else{if(X.target.id=="face"){X.preventDefault();U=true;$(document).bind("mousemove",S);document.getElementById("face").className="facepressed"}}}else{if(s){if(M(X.target)&&!F){d[X.target.id].flag()}return false}}});$(document).mouseup(function(Z){var W=f(Z);var Y;var X;if(W.left){e=false;$(document).unbind("mousemove",T).unbind("mousemove",S);if(U||!F){document.getElementById("face").className="facesmile"}if(M(Z.target)&&!F){Y=d[Z.target.id];if(s){x=true;c(d[Z.target.id],"square blank","square question");Y.reveal9()}else{if(!x){if(!g){X=q(Y)}if(!Y.reveal1()){K([Y])}if(!g){R(X);g=true}}x=false}}else{if(Z.target.id=="face"&&U){y.newGame()}}U=false}if(W.right){s=false;if(M(Z.target)&&!F){if(e){Y=d[Z.target.id];x=true;c(Y,"square blank","square question");Y.reveal9()}else{x=false}if(!F){document.getElementById("face").className="facesmile"}}}});$(document).keydown(function(W){if(W.which==113){y.newGame()}else{if(W.which==32){if(hoveredSquareId&&!F){square=d[hoveredSquareId];if(square.isRevealed()){square.reveal9()}else{square.flag()}}W.preventDefault()}}});$("#game").mouseover(function(W){if(M(W.target)){hoveredSquareId=W.target.id}});$("#game").mouseout(function(W){if(M(W.target)){if(hoveredSquareId=W.target.id){hoveredSquareId=""}}})}};